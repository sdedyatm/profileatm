<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Aplikasi Driver Atm</title>
  <!-- Manifest untuk PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0a0d12">
  <link rel="icon" href="https://iili.io/3D3VEIn.png">

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, sans-serif;
      background: linear-gradient(135deg, #0a0d12 0%, #1a1f2e 100%);
      color: #e6e8ec;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .app {
      min-height: 100vh;
      max-width: 480px;
      margin: 0 auto;
      background:
        linear-gradient(135deg, rgba(10, 13, 18, 0.92), rgba(20, 25, 35, 0.95)),
        url('https://www.transparenttextures.com/patterns/carbon-fibre.png') center/100% repeat;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .header {
      text-align: center;
      margin-bottom: 28px;
      padding: 20px 0;
    }

    .vendor {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
      margin-top: 16px;
    }

    .vendor img {
      height: 36px;
      border-radius: 14px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5), 0 4px 10px rgba(0, 0, 0, 0.3);
      transition: all 0.35s cubic-bezier(0.25, 0.8, 0.25, 1);
      opacity: 0.92;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .vendor img:hover {
      transform: translateY(-8px) scale(1.08);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6), 0 8px 16px rgba(0, 0, 0, 0.4);
      opacity: 1;
    }

    .card {
      background: rgba(25, 30, 40, 0.72);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 24px;
      border: 1px solid rgba(60, 70, 90, 0.35);
      box-shadow:
        0 12px 35px rgba(0, 0, 0, 0.55),
        0 6px 15px rgba(0, 0, 0, 0.35),
        inset 0 1px 0 rgba(255, 255, 255, 0.08),
        inset 0 -1px 0 rgba(0, 0, 0, 0.2);
      margin-bottom: 24px;
      padding: 32px;
      transition: all 0.45s cubic-bezier(0.25, 0.8, 0.25, 1);
      transform: perspective(1200px) rotateX(0deg);
      position: relative;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    }

    .card:hover {
      transform: translateY(-14px) perspective(1200px) rotateX(3deg);
      box-shadow:
        0 24px 50px rgba(0, 0, 0, 0.65),
        0 12px 25px rgba(0, 0, 0, 0.45),
        inset 0 1px 0 rgba(255, 255, 255, 0.12);
      border-color: rgba(80, 95, 120, 0.45);
    }

    .profile {
      text-align: center;
    }

    .avatar-wrapper {
      position: relative;
      display: inline-block;
      margin-bottom: 28px;
      perspective: 1200px;
    }

    .avatar {
      width: 100%;
      max-width: 340px;
      height: 240px;
      border-radius: 22px;
      object-fit: cover;
      border: 3px solid rgba(70, 85, 110, 0.6);
      box-shadow:
        0 16px 40px rgba(0, 0, 0, 0.65),
        0 8px 20px rgba(0, 0, 0, 0.4),
        inset 0 2px 10px rgba(255, 255, 255, 0.06);
      transition: all 0.45s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    .avatar:hover {
      transform: scale(1.04) rotateY(3deg);
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.75), 0 12px 30px rgba(0, 0, 0, 0.5);
      border-color: rgba(90, 105, 130, 0.7);
    }

    .profile h2 {
      font-size: 26px;
      font-weight: 800;
      margin: 10px 0;
      letter-spacing: 1px;
      background: linear-gradient(120deg, #ffffff, #a8c5ff, #7ea8ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .profile p {
      font-size: 15px;
      color: #b5bfd0;
      font-family: 'Courier New', monospace;
      margin-bottom: 28px;
      opacity: 0.9;
    }

    .detail {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 18px;
      margin-top: 36px;
      perspective: 1400px;
    }

    .info-btn {
      background: rgba(32, 38, 50, 0.8);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-radius: 20px;
      border: 1px solid rgba(70, 80, 100, 0.45);
      padding: 24px 18px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      box-shadow:
        0 12px 28px rgba(0, 0, 0, 0.55),
        0 6px 14px rgba(0, 0, 0, 0.35),
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        inset 0 -1px 0 rgba(0, 0, 0, 0.15);
      transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      cursor: pointer;
      color: #e6e8ec;
      position: relative;
      overflow: hidden;
      text-align: center;
    }

    .info-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.08), transparent);
      transition: left 0.5s ease;
    }

    .info-btn:hover::before {
      left: 100%;
    }

    .info-btn:hover {
      transform: translateY(-10px) rotateX(4deg) scale(1.04);
      box-shadow:
        0 28px 55px rgba(0, 0, 0, 0.7),
        0 14px 28px rgba(0, 0, 0, 0.45),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
      border-color: rgba(90, 105, 130, 0.55);
    }

    .info-btn:active {
      transform: translateY(-4px) rotateX(2deg) scale(1.01);
      box-shadow: 0 14px 28px rgba(0, 0, 0, 0.6), 0 7px 14px rgba(0, 0, 0, 0.4);
    }

    .info-btn .icon {
      font-size: 32px;
      position: relative;
      z-index: 1;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .info-btn .label {
      font-size: 11px;
      color: #a5b0c5;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      font-weight: 700;
      position: relative;
      z-index: 1;
    }

    .qr-toggle-btn {
      margin: 20px 0;
      padding: 18px 32px;
      background: linear-gradient(135deg, #4a90e2, #357abd);
      border: 1px solid rgba(90, 145, 210, 0.5);
      border-radius: 20px;
      font-size: 16px;
      font-weight: 700;
      color: #ffffff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      box-shadow:
        0 12px 30px rgba(74, 144, 226, 0.35),
        0 6px 15px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2),
        inset 0 -1px 0 rgba(0, 0, 0, 0.2);
      transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      position: relative;
      overflow: hidden;
    }

    .qr-toggle-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.15);
      transform: translate(-50%, -50%);
      transition: width 0.6s ease, height 0.6s ease;
    }

    .qr-toggle-btn:hover::before {
      width: 300px;
      height: 300px;
    }

    .qr-toggle-btn:hover {
      transform: translateY(-10px);
      box-shadow:
        0 20px 45px rgba(74, 144, 226, 0.45),
        0 10px 22px rgba(0, 0, 0, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
      background: linear-gradient(135deg, #5aa0f2, #4080cd);
    }

    .qr-toggle-btn:active {
      transform: translateY(-4px);
      box-shadow: 0 10px 22px rgba(74, 144, 226, 0.3), 0 5px 11px rgba(0, 0, 0, 0.4);
    }

    .qr-toggle-btn span {
      position: relative;
      z-index: 1;
    }

    .qr-panel {
      background: rgba(245, 248, 252, 0.96);
      color: #0f1115;
      border-radius: 24px;
      text-align: center;
      padding: 32px;
      box-shadow:
        0 16px 40px rgba(0, 0, 0, 0.5),
        0 8px 20px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(200, 210, 225, 0.6);
      opacity: 0;
      transform: translateY(20px) scale(0.95);
      transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
      pointer-events: none;
      max-height: 0;
      overflow: hidden;
    }

    .qr-panel.active {
      opacity: 1;
      transform: translateY(0) scale(1);
      pointer-events: auto;
      max-height: 1000px;
    }

    #qrCanvas {
      padding: 20px;
      background: white;
      border-radius: 18px;
      display: inline-block;
      box-shadow: 0 10px 28px rgba(0, 0, 0, 0.25), 0 4px 12px rgba(0, 0, 0, 0.15);
      margin-bottom: 20px;
      border: 2px solid rgba(200, 210, 225, 0.5);
    }

    #qrResult {
      font-size: 14px;
      font-weight: 800;
      letter-spacing: 1.2px;
      color: #1a1a1a;
      margin-bottom: 20px;
    }

    .action-group {
      display: flex;
      justify-content: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 16px 28px;
      border-radius: 18px;
      border: none;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.35s cubic-bezier(0.25, 0.8, 0.25, 1);
      box-shadow:
        0 10px 24px rgba(0, 0, 0, 0.35),
        0 4px 10px rgba(0, 0, 0, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transform: translate(-50%, -50%);
      transition: width 0.5s ease, height 0.5s ease;
    }

    .btn:hover::before {
      width: 250px;
      height: 250px;
    }

    .btn:active {
      transform: translateY(3px);
    }

    .btn-download {
      background: linear-gradient(135deg, #34404d, #242b35);
      color: #fff;
      border: 1px solid rgba(80, 90, 105, 0.4);
    }

    .btn-wa {
      background: linear-gradient(135deg, #25d366, #128c7e);
      color: #fff;
      border: 1px solid rgba(37, 211, 102, 0.5);
    }

    .btn:hover {
      transform: translateY(-6px);
      box-shadow: 0 18px 38px rgba(0, 0, 0, 0.5), 0 8px 18px rgba(0, 0, 0, 0.35);
    }

    .btn span {
      position: relative;
      z-index: 1;
    }

    .footer {
      text-align: center;
      font-size: 12px;
      color: #6c7688;
      padding: 36px 0 20px;
      letter-spacing: 0.6px;
      font-weight: 500;
    }

    .loading {
      font-style: italic;
      color: #8a92a4;
    }

    .error-container {
      padding: 60px 20px;
      text-align: center;
      color: #ff6b6b;
      font-size: 18px;
    }

    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(120px);
      background: rgba(30, 35, 45, 0.95);
      color: #e6e8ec;
      padding: 14px 28px;
      border-radius: 16px;
      font-size: 14px;
      font-weight: 600;
      z-index: 2000;
      border: 1px solid rgba(80, 95, 120, 0.4);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      transition: transform 0.35s cubic-bezier(0.25, 0.8, 0.25, 1);
      pointer-events: none;
      white-space: nowrap;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
    }

    .manual-id-card {
      text-align: center;
      padding: 40px 20px;
    }

    .manual-id-card h3 {
      font-size: 20px;
      margin-bottom: 16px;
      color: #a8c5ff;
    }

    .manual-id-card p {
      font-size: 14px;
      color: #b5bfd0;
      margin-bottom: 32px;
    }

    .id-input-group {
      display: flex;
      gap: 12px;
      max-width: 320px;
      margin: 0 auto;
    }

    #manualIdInput {
      flex: 1;
      padding: 16px 20px;
      border-radius: 18px;
      border: 1px solid rgba(90, 105, 130, 0.5);
      background: rgba(32, 38, 50, 0.8);
      color: #e6e8ec;
      font-size: 16px;
      backdrop-filter: blur(10px);
    }

    #manualIdInput:focus {
      outline: none;
      border-color: #4a90e2;
      box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.3);
    }

    .btn-load {
      padding: 16px 28px;
      background: linear-gradient(135deg, #4a90e2, #357abd);
      color: #fff;
      border: none;
      border-radius: 18px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(74, 144, 226, 0.3);
    }

    .btn-load:hover {
      transform: translateY(-4px);
      box-shadow: 0 14px 30px rgba(74, 144, 226, 0.4);
    }

    .overlay {
      position: fixed;
      inset: 0;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      background: #0a0d12;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .overlay-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px;
      background: rgba(20, 25, 35, 0.97);
      border-bottom: 1px solid rgba(60, 70, 90, 0.4);
      flex-shrink: 0;
      gap: 12px;
    }

    .overlay-title {
      font-size: 13px;
      font-weight: 700;
      color: #a8c5ff;
      text-transform: uppercase;
      letter-spacing: 1px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .overlay-close {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 38px;
      height: 38px;
      border-radius: 12px;
      border: 1px solid rgba(70, 80, 100, 0.45);
      background: rgba(32, 38, 50, 0.9);
      color: #e6e8ec;
      font-size: 20px;
      cursor: pointer;
      flex-shrink: 0;
      transition: all 0.25s ease;
      line-height: 1;
    }

    .overlay-close:hover {
      background: rgba(210, 60, 60, 0.8);
      border-color: rgba(210, 60, 60, 0.6);
      transform: scale(1.08);
    }

    .overlay-close:active {
      transform: scale(0.93);
    }

    .overlay-body {
      position: relative;
      flex: 1;
      min-height: 0;
    }

    .overlay-frame {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border: none;
      background: #fff;
    }

    .overlay-loading {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      color: #8a92a4;
      font-size: 14px;
      font-style: italic;
      z-index: 2;
      background: #0a0d12;
      transition: opacity 0.35s ease;
    }

    .overlay-loading .spinner {
      width: 38px;
      height: 38px;
      border: 3px solid rgba(74, 144, 226, 0.2);
      border-top-color: #4a90e2;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .overlay-loading.hidden {
      opacity: 0;
      pointer-events: none;
    }

    @media (max-width: 380px) {
      .app {
        padding: 14px;
      }

      .card {
        padding: 24px;
      }

      .avatar {
        height: 200px;
      }

      .profile h2 {
        font-size: 23px;
      }

      .btn {
        padding: 14px 22px;
        font-size: 13px;
      }

      .info-btn {
        padding: 20px 14px;
      }

      .qr-toggle-btn {
        padding: 16px 24px;
        font-size: 15px;
      }

      .id-input-group {
        flex-direction: column;
      }
    }
  </style>
</head>

<body>
  <div class="app" id="appContent">
    <header class="header">
      <div class="vendor">
        <img src="https://lh3.googleusercontent.com/pw/AP1GczOtqJeDUtihwHvC9QqFBl1YvRWqktMCBwtaQVLkt_0Xk2cRaUXdirAmfRpdDbKPsm5M8DKa40-HBirnDWfRc4SPm_nGkwehPN-6ztO1nhO8VMNi7SUZv7pwNeSQw37uNAhCJwT48eQbUkWRurpoVriu-w=w607-h607-s-no-gm?authuser=0" alt="Vendor 1">
        <img src="https://lh3.googleusercontent.com/pw/AP1GczNnm466hbB5f-58LZZy1Z8T_ztcxalTHbVkfj64fWHXZsXqJ4eqJ-XfmoE7JPo-x_ARI-XE7hEJU4sOt6HemXLGQgI2H7mE0TYWXjqB6N8soK9YNPa7HresDM3BBV3jN7CwvOdJaMleCf5lA-crG5bYLQ=w607-h607-s-no-gm?authuser=0" alt="Vendor 2">
        <img src="https://lh3.googleusercontent.com/pw/AP1GczOWw6GAGb95ab7fcismrdxl_K0dofdtUUWmXtefYnO-27FDZ2D002JB8l_VrhxfRTIXkr1fttxlFDKlSoBExicXKTsSm_mIojGDiqBU50Ag2AbvnRE6_53wlUSDLGmb3TX74YTxIKBmsXKvS0EFVp2lbg=w500-h287-s-no-gm?authuser=0" alt="Vendor 3">
        <img src="https://lh3.googleusercontent.com/pw/AP1GczNYK5V7-mbzKol_kHlrDwxuplOEt2CY5Yq00Srv8PxTHEeKoEKsvXPGr0NP4kM6VFSm-b9xfN0h-gJidu0SoM9gV9pzsbNadNwpQdZvGM9oA-1QiUz5csONmYyBfkuRSCZGIuHFzVtoALQB8qaUIi8ukQ=w1366-h422-s-no-gm?authuser=0" alt="Vendor 4">
      </div>
    </header>

    <section class="card manual-id-card" id="manualIdSection">
      <h3>Masukkan ID Driver</h3>
      <p>Masukkan kode ID driver Anda (contoh: ATM-3301151)</p>
      <div class="id-input-group">
        <input type="text" id="manualIdInput" placeholder="ID Driver" autocomplete="off">
        <button class="btn-load" id="loadBtn">Muat Profil</button>
      </div>
    </section>

    <section class="card profile" id="profileSection" style="display: none;">
      <div class="avatar-wrapper">
        <img id="avatar" class="avatar" src="https://via.placeholder.com/340x240?text=Loading..." alt="Avatar">
      </div>
      <h2 id="nama" class="loading">Memuat data...</h2>
      <p id="idDriver">‚Äî</p>

      <div class="detail">
        <button type="button" class="info-btn" onclick="openField('hp')">
          <div class="icon"></div>
          <div class="label">SOP Driver</div>
        </button>

        <button type="button" class="info-btn" onclick="openField('plat')">
          <div class="icon"></div>
          <div class="label">Database</div>
        </button>

        <button type="button" class="info-btn" onclick="openField('member')">
          <div class="icon"></div>
          <div class="label">Apps</div>
        </button>

        <button type="button" class="info-btn" onclick="openField('rute')">
          <div class="icon"></div>
          <div class="label">Koordinator</div>
        </button>
      </div>

      <center>
        <button class="qr-toggle-btn" onclick="toggleQRSection()">
          <span></span>
          <span id="qrToggleText">Tampilkan QR Code</span>
        </button>
      </center>
    </section>

    <section class="card qr-panel" id="qrSection">
      <div id="qrCanvas"></div>
      <div id="qrResult">PROFIL DIGITAL DRIVER</div>
      <div class="action-group">
        <button onclick="downloadQR()" class="btn btn-download">
          <span></span><span>Simpan QR</span>
        </button>
        <button onclick="shareWhatsApp()" class="btn btn-wa">
          <span></span><span>Share WA</span>
        </button>
      </div>
    </section>

    <div class="footer">CV AMELIA TRANS MANDIRI ‚Äì CIKAMPEK</div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="overlay" id="overlay">
    <div class="overlay-header">
      <div class="overlay-title" id="overlayTitle">‚Äî</div>
      <button class="overlay-close" onclick="closeOverlay()">‚úï</button>
    </div>
    <div class="overlay-body">
      <div class="overlay-loading" id="overlayLoading">
        <div class="spinner"></div>
        <span>Memuat halaman...</span>
      </div>
      <iframe class="overlay-frame" id="overlayFrame" src="" allowfullscreen></iframe>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    const BASE_URL = "https://script.google.com/macros/s/AKfycbw3Uu4ZLTinKD8eNMFPyAfHjzjyb3_ozNewTwRVwJ-cqHJ5K7NmfnSNgYxmWM_XZnG8aA/exec";
    let driverCache = null;
    let currentDriverId = null;
    let qrGenerated = false;
    let deferredPrompt;
    var FIELD_LABELS = {
      hp: "SOP Driver",
      plat: "Database",
      member: "Apps",
      rute: "Koordinator"
    };
    var OPEN_IN_NEW_TAB_FIELDS = ['member'];
    var toastTimer = null;

    function showToast(msg) {
      var t = document.getElementById("toast");
      t.innerText = msg;
      t.classList.add("show");
      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(function() {
        t.classList.remove("show");
      }, 2200);
    }

    function renderDriver(d) {
      if (!d || d.error) {
        document.getElementById("manualIdSection").style.display = "block";
        document.getElementById("profileSection").style.display = "none";
        showToast("‚ùå " + (d?.error || "Data tidak ditemukan"));
        return;
      }
      driverCache = d;
      document.getElementById("manualIdSection").style.display = "none";
      document.getElementById("profileSection").style.display = "block";
      document.getElementById("nama").innerText = d.nama || "Tanpa Nama";
      document.getElementById("nama").classList.remove("loading");
      document.getElementById("idDriver").innerText = d.id || "-";
      var foto = (d.foto || "").toString().trim();
      document.getElementById("avatar").src = (foto.length > 10) ? foto : "https://via.placeholder.com/340x240?text=NO+PHOTO";
      showInstallButton();
    }

    function loadWithFetch(id) {
      showToast("üîÑ Memuat data...");
      fetch(BASE_URL + "?id=" + encodeURIComponent(id))
        .then(res => {
          if (!res.ok) {
            throw new Error("HTTP " + res.status + " - Periksa permission Apps Script");
          }
          return res.json();
        })
        .then(renderDriver)
        .catch(err => {
          showToast("‚ùå Gagal fetch: " + err.message);
          console.error("Fetch error:", err);
          document.getElementById("manualIdSection").style.display = "block";
          document.getElementById("profileSection").style.display = "none";
        });
    }

    function loadManualId() {
      var input = document.getElementById("manualIdInput").value.trim();
      if (!input) {
        showToast("‚ö†Ô∏è Masukkan ID driver");
        return;
      }
      var id = input.toUpperCase();
      currentDriverId = id;
      localStorage.setItem('lastDriverId', id);
      history.replaceState(null, '', '?id=' + encodeURIComponent(id));
      loadWithFetch(id);
    }
    document.getElementById("manualIdInput").addEventListener("keypress", function(e) {
      if (e.key === "Enter") loadManualId();
    });
    document.getElementById("loadBtn").addEventListener("click", loadManualId);

    function openField(field) {
      if (!driverCache) return;
      var url = (driverCache[field] || "").toString().trim();
      if (!url || url === "-" || url === "") {
        showToast("‚ö†Ô∏è URL tidak tersedia.");
        return;
      }
      if (OPEN_IN_NEW_TAB_FIELDS.includes(field)) {
        window.open(url, '_blank');
        showToast("üì± Membuka Apps di tab baru");
        return;
      }
      document.getElementById("overlayTitle").innerText = FIELD_LABELS[field] || field;
      document.getElementById("overlayLoading").classList.remove("hidden");
      document.getElementById("overlayFrame").src = url;
      document.getElementById("overlay").classList.add("active");
    }

    function closeOverlay() {
      document.getElementById("overlay").classList.remove("active");
      setTimeout(() => {
        document.getElementById("overlayFrame").src = "";
        document.getElementById("overlayLoading").classList.remove("hidden");
      }, 350);
    }
    document.getElementById("overlayFrame").addEventListener("load", () => {
      document.getElementById("overlayLoading").classList.add("hidden");
    });

    function toggleQRSection() {
      var sec = document.getElementById("qrSection");
      var text = document.getElementById("qrToggleText");
      if (sec.classList.contains("active")) {
        sec.classList.remove("active");
        text.innerText = "Tampilkan QR Code";
      } else {
        if (!qrGenerated && driverCache) generateQRCode();
        sec.classList.add("active");
        text.innerText = "Sembunyikan QR Code";
      }
    }

    function generateQRCode() {
      var profileUrl = location.origin + location.pathname + "?id=" + encodeURIComponent(driverCache.id); // Gunakan URL Vercel
      var container = document.getElementById("qrCanvas");
      container.innerHTML = "";
      new QRCode(container, {
        text: profileUrl,
        width: 220,
        height: 220,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });
      qrGenerated = true;
    }

    function downloadQR() {
      var canvas = document.querySelector("#qrCanvas canvas");
      if (!canvas) return showToast("‚ö†Ô∏è QR belum siap");
      var a = document.createElement("a");
      a.download = "QR_Driver_" + (driverCache.id || "unknown") + ".png";
      a.href = canvas.toDataURL("image/png");
      a.click();
      showToast("‚úì QR disimpan");
    }

    function shareWhatsApp() {
      if (!driverCache) return;
      var profileUrl = location.origin + location.pathname + "?id=" + encodeURIComponent(driverCache.id);
      var msg = "Profile Driver:\n\n*Nama:* " + driverCache.nama + "\n*ID:* " + driverCache.id + "\n*Plat:* " + (driverCache.plat || "-") + "\n\nLihat profil:\n" + profileUrl;
      window.open("https://wa.me/?text=" + encodeURIComponent(msg), "_blank");
    }

    function showInstallButton() {
      const footer = document.querySelector('.footer');
      if (document.getElementById('installBtn')) return;
      const btn = document.createElement('button');
      btn.id = 'installBtn';
      btn.innerText = 'üì≤ Install Aplikasi';
      btn.style = 'margin: 20px auto; padding: 14px 28px; background: #4a90e2; color: white; border: none; border-radius: 18px; font-weight: 700; cursor: pointer; display: block;';
      btn.onclick = () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          deferredPrompt.userChoice.then(choice => {
            if (choice.outcome === 'accepted') showToast('‚úì PWA diinstall');
            deferredPrompt = null;
          });
        }
      };
      footer.parentNode.insertBefore(btn, footer);
    }
    window.addEventListener('beforeinstallprompt', (e) => {
      deferredPrompt = e;
      e.preventDefault();
    });
    window.onload = function() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/service-worker.js')
          .then(() => console.log('SW registered'))
          .catch(err => {
            console.error('SW registration failed:', err);
            showToast("‚ö†Ô∏è Service Worker error");
          });
      }
      const params = new URLSearchParams(window.location.search);
      const urlId = params.get("id");
      if (urlId) {
        currentDriverId = urlId.toUpperCase();
        localStorage.setItem('lastDriverId', currentDriverId);
        loadWithFetch(currentDriverId);
      } else {
        const savedId = localStorage.getItem('lastDriverId');
        if (savedId) {
          showToast("üì± Memuat profil terakhir: " + savedId);
          currentDriverId = savedId;
          history.replaceState(null, '', '?id=' + encodeURIComponent(savedId));
          loadWithFetch(savedId);
        } else {
          document.getElementById("manualIdSection").style.display = "block";
        }
      }
    };
  </script>
</body>

</html>
